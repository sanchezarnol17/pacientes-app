<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pacientes & Mini Contabilidad — Sheets</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    input[type=file]{display:none}
    dialog[open]{display:block}
    .tab-active{background:#111827;color:white}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <nav class="bg-white border-b sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">☁️</span>
        <h1 class="text-xl font-semibold">Pacientes & Mini Contabilidad</h1>
      </div>
      <div class="flex items-center gap-2">
        <div class="inline-flex rounded-xl overflow-hidden border">
          <button id="tabPatients" class="px-3 py-2 hover:bg-gray-100">Pacientes</button>
          <button id="tabAccounting" class="px-3 py-2 hover:bg-gray-100">Contabilidad</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Subnav Pacientes -->
  <div id="subnavPatients" class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <button id="btnAdd" type="button" class="px-3 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Nuevo paciente</button>
        <button id="btnReload" type="button" class="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Actualizar</button>
      </div>
      <div id="netState" class="text-sm text-gray-500"></div>
    </div>
  </div>

  <!-- Subnav Contabilidad -->
  <div id="subnavAccounting" class="hidden bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 grid gap-3 md:grid-cols-12">
      <input id="txSearch" class="md:col-span-5 px-3 py-2 rounded-xl border" placeholder="Buscar (concepto, categoría, método, paciente)" />
      <select id="txType" class="md:col-span-2 px-3 py-2 rounded-xl border">
        <option value="">Tipo: todos</option>
        <option value="ingreso">Ingreso</option>
        <option value="gasto">Gasto</option>
      </select>
      <input id="txFrom" type="date" class="md:col-span-2 px-3 py-2 rounded-xl border" />
      <input id="txTo" type="date" class="md:col-span-2 px-3 py-2 rounded-xl border" />
      <div class="md:col-span-1 flex gap-2">
        <button id="btnTxClear" class="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 w-full">Limpiar</button>
      </div>
    </div>
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex gap-2">
        <button id="btnTxAdd" class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Agregar mov.</button>
        <button id="btnTxReload" class="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Actualizar</button>
        <button id="btnTxExport" class="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Exportar CSV</button>
      </div>
      <div id="netStateTx" class="text-sm text-gray-500"></div>
    </div>
  </div>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- PACIENTES -->
    <section id="patientsView">
      <div class="mb-4 grid grid-cols-1 md:grid-cols-6 gap-3">
        <input id="search" class="md:col-span-4 px-3 py-2 rounded-xl border" placeholder="Buscar por nombre, documento o teléfono" />
        <button id="btnClear" type="button" class="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Limpiar</button>
        <div class="md:justify-self-end"></div>
      </div>
      <div id="list" class="grid gap-3"></div>

      <dialog id="patientDialog" class="rounded-2xl p-0 w-full max-w-2xl">
        <form id="patientForm" method="dialog" class="bg-white rounded-2xl shadow p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <h2 class="md:col-span-2 text-xl font-semibold"><span id="dialogTitle">Nuevo paciente</span></h2>
          <input type="hidden" id="p_id" />
          <div>
            <label class="block text-sm text-gray-600">Nombre completo *</label>
            <input id="p_full_name" required class="mt-1 px-3 py-2 rounded-xl border w-full" />
          </div>
          <div>
            <label class="block text-sm text-gray-600">Documento</label>
            <input id="p_document_id" class="mt-1 px-3 py-2 rounded-xl border w-full" />
          </div>
          <div>
            <label class="block text-sm text-gray-600">Teléfono</label>
            <input id="p_phone" class="mt-1 px-3 py-2 rounded-xl border w-full" />
          </div>
          <div>
            <label class="block text-sm text-gray-600">Email</label>
            <input id="p_email" type="email" class="mt-1 px-3 py-2 rounded-xl border w-full" />
          </div>
          <div>
            <label class="block text-sm text-gray-600">Fecha de nacimiento</label>
            <input id="p_birthdate" type="date" class="mt-1 px-3 py-2 rounded-xl border w-full" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-gray-600">Dirección</label>
            <input id="p_address" class="mt-1 px-3 py-2 rounded-xl border w-full" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-gray-600">Notas</label>
            <textarea id="p_notes" rows="3" class="mt-1 px-3 py-2 rounded-xl border w-full"></textarea>
          </div>
          <div class="md:col-span-2 flex items-center gap-2 justify-end">
            <button type="button" id="btnCancel" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cancelar</button>
            <button type="submit" id="btnSavePatient" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Guardar</button>
          </div>
        </form>
      </dialog>

      <section id="detail" class="hidden"></section>
    </section>

    <!-- CONTABILIDAD -->
    <section id="accountingView" class="hidden">
      <!-- Tarjetas -->
      <div class="grid gap-4 md:grid-cols-3">
        <div class="bg-white rounded-2xl shadow p-5">
          <div class="text-sm text-gray-500">Ingresos</div>
          <div id="cardIncome" class="text-2xl font-bold">—</div>
        </div>
        <div class="bg-white rounded-2xl shadow p-5">
          <div class="text-sm text-gray-500">Gastos</div>
          <div id="cardExpense" class="text-2xl font-bold">—</div>
        </div>
        <div class="bg-white rounded-2xl shadow p-5">
          <div class="text-sm text-gray-500">Balance</div>
          <div id="cardBalance" class="text-2xl font-bold">—</div>
        </div>
      </div>

      <!-- Listado -->
      <div class="bg-white rounded-2xl shadow p-5 mt-4">
        <div id="txList" class="grid gap-2"></div>
      </div>

      <!-- Dialog movimiento -->
      <dialog id="txDialog" class="rounded-2xl p-0 w-full max-w-2xl">
        <form id="txForm" method="dialog" class="bg-white rounded-2xl shadow p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <h2 class="md:col-span-2 text-xl font-semibold"><span id="txDialogTitle">Nuevo movimiento</span></h2>
          <input type="hidden" id="t_id" />
          <div>
            <label class="block text-sm text-gray-600">Fecha *</label>
            <input id="t_date" type="date" required class="mt-1 px-3 py-2 rounded-xl border w-full" />
          </div>
          <div>
            <label class="block text-sm text-gray-600">Tipo *</label>
            <select id="t_type" required class="mt-1 px-3 py-2 rounded-xl border w-full">
              <option value="ingreso">Ingreso</option>
              <option value="gasto">Gasto</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-600">Categoría *</label>
            <input id="t_category" required class="mt-1 px-3 py-2 rounded-xl border w-full" placeholder="consulta, procedimientos, insumos, arriendo..." />
          </div>
          <div>
            <label class="block text-sm text-gray-600">Monto *</label>
            <input id="t_amount" type="number" step="0.01" required class="mt-1 px-3 py-2 rounded-xl border w-full" />
          </div>
          <div>
            <label class="block text-sm text-gray-600">Método de pago</label>
            <input id="t_method" class="mt-1 px-3 py-2 rounded-xl border w-full" placeholder="efectivo, tarjeta, transferencia..." />
          </div>
          <div>
            <label class="block text-sm text-gray-600">Paciente (opcional)</label>
            <input id="t_patient" class="mt-1 px-3 py-2 rounded-xl border w-full" placeholder="ID o nombre" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-gray-600">Concepto *</label>
            <input id="t_concept" required class="mt-1 px-3 py-2 rounded-xl border w-full" placeholder="Descripción breve" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-gray-600">Notas</label>
            <textarea id="t_notes" rows="3" class="mt-1 px-3 py-2 rounded-xl border w-full"></textarea>
          </div>
          <div class="md:col-span-2 flex items-center gap-2 justify-end">
            <button type="button" id="btnTxCancel" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cancelar</button>
            <button type="submit" id="btnTxSave" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Guardar</button>
          </div>
        </form>
      </dialog>
    </section>
  </main>

  <footer class="text-center text-xs text-gray-500 py-6">Datos guardados en Google Sheets mediante Apps Script.</footer>

  <script defer>
  // ===== TU URL /exec (Apps Script desplegado)
  const API_URL = 'https://script.google.com/macros/s/AKfycbwdmuKEX_3m8pUTYPZrZUmNNZ7A1t4jYlnxzhQiMQU57VGRIeqH2SBV4OJTEaRoHFmUOw/exec';

  // Helpers
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const show = (el,flag)=> el.classList.toggle('hidden', !flag);
  const netState   = $('#netState');
  const netStateTx = $('#netStateTx');
  const showNet   = m => netState.textContent = m || '';
  const showNetTx = m => netStateTx.textContent = m || '';

  // Polyfill dialog
  document.addEventListener('DOMContentLoaded', () => {
    for(const dlg of $$('dialog')){
      if(!dlg.showModal){ dlg.showModal = ()=> dlg.setAttribute('open',''); dlg.close = ()=> dlg.removeAttribute('open'); }
    }
  });

  // API sin headers (evita preflight)
  async function apiGet(params){
    const url = new URL(API_URL);
    Object.entries(params||{}).forEach(([k,v])=> url.searchParams.set(k, v));
    const res = await fetch(url.toString());
    const txt = await res.text();
    try { return JSON.parse(txt); } catch { return []; }
  }
  async function apiPost(body){
    const res = await fetch(API_URL, { method:'POST', body: JSON.stringify(body) });
    const txt = await res.text();
    try { return JSON.parse(txt); } catch { return { ok:true, raw: txt }; }
  }

  // Estado
  let state = {
    patients: [], query:'',
    tx: [], txQuery:'', txType:'', txFrom:'', txTo:''
  };

  // Tabs
  const tabPatients=$('#tabPatients'), tabAccounting=$('#tabAccounting');
  const patientsView=$('#patientsView'), accountingView=$('#accountingView');
  const subnavPatients=$('#subnavPatients'), subnavAccounting=$('#subnavAccounting');
  function setTab(t){
    const isP = t==='patients';
    show(patientsView,isP); show(subnavPatients,isP);
    show(accountingView,!isP); show(subnavAccounting,!isP);
    tabPatients.classList.toggle('tab-active', isP);
    tabAccounting.classList.toggle('tab-active', !isP);
  }
  tabPatients.onclick=()=> setTab('patients');
  tabAccounting.onclick=()=> setTab('accounting');

  // ===== PACIENTES (igual que tu módulo base) =====
  document.addEventListener('DOMContentLoaded', () => {
    const listEl = $('#list'), detailEl = $('#detail');
    const searchEl = $('#search'), dlg = $('#patientDialog'), form = $('#patientForm');

    $('#btnAdd').onclick = () => openForm();
    $('#btnReload').onclick = () => loadPatients();
    $('#btnClear').onclick = () => { searchEl.value=''; state.query=''; renderList(); };
    $('#btnCancel').onclick = () => dlg.close();
    searchEl.oninput = () => { state.query = searchEl.value; renderList(); };

    function humanDate(d){ return d ? new Date(d).toISOString().slice(0,10) : '—'; }

    function renderList(){
      detailEl.classList.add('hidden');
      listEl.innerHTML = '';
      const q = (state.query||'').toLowerCase();
      const rows = state.patients.filter(p=>(`${p.nombre||''} ${p.documento||''} ${p.telefono||''}`).toLowerCase().includes(q));
      if(!rows.length){ listEl.innerHTML = '<div class="text-gray-500">No hay pacientes.</div>'; return; }
      for(const p of rows){
        const div = document.createElement('div');
        div.className='bg-white rounded-2xl shadow p-4 flex items-center justify-between';
        div.innerHTML = `
          <div>
            <button class="text-lg font-semibold hover:underline" data-open="${p.id}">${p.nombre}</button>
            <div class="text-sm text-gray-500">Doc: ${p.documento||'—'} · Tel: ${p.telefono||'—'} · Reg: ${humanDate(p.fecha_creacion)}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="px-3 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600" data-edit="${p.id}">Editar</button>
            <button class="px-3 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700" data-del="${p.id}">Eliminar</button>
          </div>`;
        listEl.appendChild(div);
      }
      listEl.querySelectorAll('[data-open]').forEach(b=> b.onclick = ()=> openDetail(b.dataset.open));
      listEl.querySelectorAll('[data-edit]').forEach(b=> b.onclick = ()=> openForm(b.dataset.edit));
      listEl.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=> deletePatient(b.dataset.del));
    }

    function openForm(id){
      form.reset();
      $('#dialogTitle').textContent = id ? 'Editar paciente' : 'Nuevo paciente';
      $('#p_id').value = id || '';
      if(id){
        const p = state.patients.find(x=> x.id===id);
        if(p){
          $('#p_full_name').value=p.nombre||'';
          $('#p_document_id').value=p.documento||'';
          $('#p_phone').value=p.telefono||'';
          $('#p_email').value=p.email||'';
          $('#p_birthdate').value=p.fecha_nacimiento||'';
          $('#p_address').value=p.direccion||'';
          $('#p_notes').value=p.notas||'';
        }
      }
      dlg.showModal();
    }

    form.onsubmit = async (ev)=>{
      ev.preventDefault();
      const id = $('#p_id').value || ('p_' + Date.now().toString(36));
      const payload = { action:'upsert_patient', data:{
        id,
        nombre: $('#p_full_name').value.trim(),
        documento: $('#p_document_id').value.trim(),
        telefono: $('#p_phone').value.trim(),
        email: $('#p_email').value.trim(),
        fecha_nacimiento: $('#p_birthdate').value || '',
        direccion: $('#p_address').value.trim(),
        notas: $('#p_notes').value.trim()
      }};
      if(!payload.data.nombre){ alert('El nombre es obligatorio.'); return; }
      try{ showNet('Guardando...'); await apiPost(payload); dlg.close(); await loadPatients(); showNet('Guardado ✓'); setTimeout(()=>showNet(''),1500);}
      catch(e){ alert('Error guardando: '+e.message); showNet('Error'); }
    };

    async function deletePatient(id){
      const p = state.patients.find(x=> x.id===id);
      if(!p) return; if(!confirm(`¿Eliminar a "${p.nombre}"?`)) return;
      try{ showNet('Eliminando...'); await apiPost({ action:'delete_patient', data:{ id } }); await loadPatients(); showNet('Eliminado ✓'); setTimeout(()=>showNet(''),1500);}catch(e){ alert('Error: '+e.message); }
    }

    async function openDetail(id){
      const p = state.patients.find(x=> x.id===id);
      if(!p) return;
      detailEl.classList.remove('hidden');
      function humanDate(d){ return d ? new Date(d).toISOString().slice(0,10) : '—'; }
      detailEl.innerHTML = `
        <div class="bg-white rounded-2xl shadow p-6 mb-4">
          <div class="flex items-start justify-between">
            <div>
              <h2 class="text-2xl font-bold">${p.nombre}</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 text-sm">
                <div><span class="text-gray-500">Documento:</span> ${p.documento||'—'}</div>
                <div><span class="text-gray-500">Teléfono:</span> ${p.telefono||'—'}</div>
                <div><span class="text-gray-500">Email:</span> ${p.email||'—'}</div>
                <div><span class="text-gray-500">Fecha nac.:</span> ${humanDate(p.fecha_nacimiento)}</div>
                <div class="md:col-span-2"><span class="text-gray-500">Dirección:</span> ${p.direccion||'—'}</div>
                <div class="md:col-span-2"><span class="text-gray-500">Notas:</span> ${p.notas||'—'}</div>
              </div>
            </div>
            <div class="space-x-2">
              <button class="px-3 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600" data-edit="${p.id}">Editar</button>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow p-6">
          <h3 class="text-xl font-semibold mb-3">Historial clínico</h3>
          <form id="histForm" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
            <input type="date" id="h_date" class="px-3 py-2 rounded-xl border" value="${new Date().toISOString().slice(0,10)}" />
            <input id="h_summary" class="md:col-span-2 px-3 py-2 rounded-xl border" placeholder="Resumen (Motivo/Diagnóstico/Procedimiento)" />
            <textarea id="h_details" rows="3" class="md:col-span-3 px-3 py-2 rounded-xl border" placeholder="Detalles/Observaciones"></textarea>
            <div class="md:col-span-3">
              <button class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Añadir</button>
            </div>
          </form>
          <div id="historyList" class="grid gap-3"></div>
        </div>`;

      detailEl.querySelector('[data-edit]').onclick = ()=> openForm(p.id);

      const histForm = $('#histForm'), hList = $('#historyList');

      function renderHistory(items){
        function humanDate(d){ return d ? new Date(d).toISOString().slice(0,10) : '—'; }
        const rows = (items||[]).slice().sort((a,b)=> String(b.fecha||'').localeCompare(String(a.fecha||'')));
        hList.innerHTML = rows.length ? '' : '<div class="text-gray-500">Aún no hay registros.</div>';
        for(const h of rows){
          const art = document.createElement('article');
          art.className = 'bg-gray-50 rounded-2xl p-4 border';
          art.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="font-medium">${humanDate(h.fecha)} — ${h.resumen||''}</div>
              <button class="text-red-600 hover:underline" data-del-h="${h.id}">Eliminar</button>
            </div>
            ${h.detalles ? `<p class="text-sm text-gray-700 mt-1 whitespace-pre-line">${h.detalles}</p>` : ''}`;
          hList.appendChild(art);
        }
        hList.querySelectorAll('[data-del-h]').forEach(btn=> btn.onclick = async ()=>{
          if(!confirm('¿Eliminar esta entrada del historial?')) return;
          try{ showNet('Eliminando historial...'); await apiPost({ action:'delete_history', data:{ id: btn.dataset.delH, patient_id: p.id } }); await loadHistory(); showNet('Eliminado ✓'); setTimeout(()=>showNet(''),1500);}catch(e){ alert('Error eliminando historial: '+e.message); }
        });
      }

      async function loadHistory(){
        try{ showNet('Cargando historial...'); const data = await apiGet({ mode:'histories', patient_id: p.id }); renderHistory(data); showNet(''); }
        catch(e){ hList.innerHTML = `<div class='text-red-700 bg-red-50 border border-red-200 rounded-xl p-3'>No se pudo cargar el historial.<br><small>${e.message}</small></div>`; showNet('Error'); }
      }

      histForm.onsubmit = async (e)=>{
        e.preventDefault();
        const summary = $('#h_summary').value.trim();
        if(!summary){ alert('El resumen es obligatorio.'); return; }
        try{
          showNet('Guardando historial...');
          await apiPost({ action:'add_history', data:{
            id: 'h_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6),
            patient_id: p.id,
            fecha: $('#h_date').value || new Date().toISOString().slice(0,10),
            resumen: summary,
            detalles: $('#h_details').value.trim()
          }});
          histForm.reset();
          $('#h_date').value = new Date().toISOString().slice(0,10);
          await loadHistory();
          showNet('Historial guardado ✓'); setTimeout(()=> showNet(''), 1500);
        }catch(err){ alert('Error guardando historial: '+err.message); showNet('Error'); }
      };

      await loadHistory();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function loadPatients(){
      try{ showNet('Cargando...'); const data = await apiGet({ mode:'patients' }); state.patients = Array.isArray(data)?data:[]; renderList(); showNet(''); }
      catch(e){ listEl.innerHTML = `<div class='text-red-700 bg-red-50 border border-red-200 rounded-xl p-3'>No se pudo cargar desde Google Sheets. Revisa la URL del script y permisos. <br><small>${e.message}</small></div>`; showNet('Error'); }
    }

    // Inicio
    setTab('patients');
    loadPatients();
  });

  // ===== CONTABILIDAD (mini) =====
  const txDialog = $('#txDialog'), txForm = $('#txForm');
  $('#btnTxAdd').onclick = ()=> openTxForm();
  $('#btnTxReload').onclick = ()=> loadTx();
  $('#btnTxClear').onclick = ()=>{
    $('#txSearch').value=''; $('#txType').value=''; $('#txFrom').value=''; $('#txTo').value='';
    state.txQuery=''; state.txType=''; state.txFrom=''; state.txTo=''; renderTx();
  };
  $('#btnTxExport').onclick = exportTxCSV;
  $('#btnTxCancel').onclick = ()=> txDialog.close();
  $('#txSearch').oninput = e=> { state.txQuery=e.target.value; renderTx(); };
  $('#txType').onchange  = e=> { state.txType=e.target.value; renderTx(); };
  $('#txFrom').onchange  = e=> { state.txFrom=e.target.value; renderTx(); };
  $('#txTo').onchange    = e=> { state.txTo=e.target.value; renderTx(); };

  function openTxForm(id){
    txForm.reset();
    $('#t_id').value = id || '';
    $('#t_date').value = new Date().toISOString().slice(0,10);
    $('#txDialogTitle').textContent = id ? 'Editar movimiento' : 'Nuevo movimiento';
    if(id){
      const t = state.tx.find(x=> x.id===id);
      if(t){
        $('#t_date').value=t.fecha||new Date().toISOString().slice(0,10);
        $('#t_type').value=t.tipo||'ingreso';
        $('#t_category').value=t.categoria||'';
        $('#t_amount').value=t.monto||'';
        $('#t_method').value=t.metodo||'';
        $('#t_patient').value=t.paciente||'';
        $('#t_concept').value=t.concepto||'';
        $('#t_notes').value=t.notas||'';
      }
    }
    txDialog.showModal();
  }

  txForm.onsubmit = async (e)=>{
    e.preventDefault();
    const id = $('#t_id').value || ('t_' + Date.now().toString(36));
    const data = {
      id,
      fecha: $('#t_date').value,
      tipo: $('#t_type').value,
      categoria: $('#t_category').value.trim(),
      concepto: $('#t_concept').value.trim(),
      monto: Number($('#t_amount').value),
      metodo: $('#t_method').value.trim(),
      paciente: $('#t_patient').value.trim(),
      notas: $('#t_notes').value.trim()
    };
    if(!data.fecha || !data.tipo || !data.categoria || !data.concepto || !data.monto){
      alert('Completa fecha, tipo, categoría, concepto y monto.'); return;
    }
    try{
      showNetTx('Guardando movimiento...');
      await apiPost({ action:'upsert_tx', data });
      txDialog.close();
      await loadTx();
      showNetTx('Guardado ✓'); setTimeout(()=> showNetTx(''), 1500);
    }catch(err){ alert('Error guardando: '+err.message); showNetTx('Error'); }
  };

  async function deleteTx(id){
    const t = state.tx.find(x=> x.id===id);
    if(!t) return;
    if(!confirm(`¿Eliminar "${t.tipo} • ${t.concepto}"?`)) return;
    try{ showNetTx('Eliminando...'); await apiPost({ action:'delete_tx', data:{ id } }); await loadTx(); showNetTx('Eliminado ✓'); setTimeout(()=>showNetTx(''),1500);}
    catch(err){ alert('Error: '+err.message); showNetTx('Error'); }
  }

  function human(n){
    if(n===undefined||n===null||isNaN(n)) return '—';
    return n.toLocaleString('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:0 });
  }

  function renderTx(){
    const list = $('#txList');
    const q = (state.txQuery||'').toLowerCase();
    const from = state.txFrom ? new Date(state.txFrom) : null;
    const to   = state.txTo   ? new Date(state.txTo)   : null;

    const rows = state.tx.filter(t=>{
      const text = `${t.concepto||''} ${t.categoria||''} ${t.metodo||''} ${t.paciente||''}`.toLowerCase();
      const passQ = !q || text.includes(q);
      const passType = !state.txType || t.tipo === state.txType;
      const dateOk = (()=>{
        if(!t.fecha) return true;
        const d = new Date(t.fecha+'T00:00:00');
        if(from && d < from) return false;
        if(to   && d > to)   return false;
        return true;
      })();
      return passQ && passType && dateOk;
    }).sort((a,b)=> String(b.fecha||'').localeCompare(String(a.fecha||'')));

    // render
    list.innerHTML = rows.length ? '' : '<div class="text-gray-500">Sin movimientos.</div>';
    for(const t of rows){
      const card = document.createElement('div');
      card.className = 'border rounded-2xl p-4 flex items-center justify-between';
      card.innerHTML = `
        <div>
          <div class="font-semibold">${t.tipo==='ingreso'?'🟢 Ingreso':'🔴 Gasto'} — ${t.concepto||'(sin concepto)'} <span class="text-gray-500">· ${t.categoria||'—'}</span></div>
          <div class="text-sm text-gray-500">${t.fecha||'—'} · ${t.metodo||'—'} ${t.paciente?('· Paciente: '+t.paciente):''}</div>
          ${t.notas? `<div class="text-sm mt-1">${t.notas}</div>`: '' }
        </div>
        <div class="flex items-center gap-2">
          <div class="font-bold ${t.tipo==='ingreso'?'text-emerald-700':'text-red-700'}">${human(Number(t.monto||0))}</div>
          <button class="px-3 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600" data-tx-edit="${t.id}">Editar</button>
          <button class="px-3 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700" data-tx-del="${t.id}">Eliminar</button>
        </div>`;
      list.appendChild(card);
    }
    list.querySelectorAll('[data-tx-edit]').forEach(b=> b.onclick = ()=> openTxForm(b.dataset.txEdit));
    list.querySelectorAll('[data-tx-del]').forEach(b=> b.onclick = ()=> deleteTx(b.dataset.txDel));

    // Totales
    const totals = rows.reduce((acc,t)=>{ (t.tipo==='ingreso'? acc.in : acc.out) += Number(t.monto||0); return acc; }, {in:0,out:0});
    $('#cardIncome').textContent  = human(totals.in);
    $('#cardExpense').textContent = human(totals.out);
    const bal = totals.in - totals.out;
    const balEl = $('#cardBalance');
    balEl.textContent = human(bal);
    balEl.className = 'text-2xl font-bold ' + (bal>=0?'text-emerald-700':'text-red-700');
  }

  async function loadTx(){
    try{ showNetTx('Cargando movimientos...'); const data = await apiGet({ mode:'transactions' }); state.tx = Array.isArray(data)?data:[]; renderTx(); showNetTx(''); }
    catch(e){ $('#txList').innerHTML = `<div class='text-red-700 bg-red-50 border border-red-200 rounded-xl p-3'>No se pudo cargar movimientos.<br><small>${e.message}</small></div>`; showNetTx('Error'); }
  }

  function exportTxCSV(){
    const headers = ['id','fecha','tipo','categoria','concepto','monto','metodo','paciente','notas'];
    const q = (state.txQuery||'').toLowerCase();
    const from = state.txFrom ? new Date(state.txFrom) : null;
    const to   = state.txTo   ? new Date(state.txTo)   : null;
    const rows = state.tx.filter(t=>{
      const text = `${t.concepto||''} ${t.categoria||''} ${t.metodo||''} ${t.paciente||''}`.toLowerCase();
      const okQ = !q || text.includes(q);
      const okType = !state.txType || t.tipo === state.txType;
      const okDate = (()=>{
        if(!t.fecha) return true;
        const d = new Date(t.fecha+'T00:00:00');
        if(from && d < from) return false;
        if(to   && d > to)   return false;
        return true;
      })();
      return okQ && okType && okDate;
    });
    const csv = [headers.join(',')].concat(rows.map(t=> headers.map(h=>{
      const val = (t[h]!==undefined && t[h]!==null) ? String(t[h]).replaceAll('"','""') : '';
      return `"${val}"`;
    }).join(','))).join('\n');
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href = url; a.download = `movimientos_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // Cargar contabilidad al iniciar (para que al cambiar de pestaña ya esté)
  document.addEventListener('DOMContentLoaded', loadTx);
  </script>
<!-- 🔧 Hotfix 2: listeners ultra-compatibles -->
<script defer>
window.addEventListener('load', function(){
  function $(s){ return document.querySelector(s); }
  function show(el,flag){ if(el){ el.classList.toggle('hidden', !flag); } }

  function setTabSafe(tab){
    var isP = (tab === 'patients');
    show($('#patientsView'), isP);
    show($('#subnavPatients'), isP);
    show($('#accountingView'), !isP);
    show($('#subnavAccounting'), !isP);
    var tp = $('#tabPatients');  if(tp){ tp.classList.toggle('tab-active', isP); }
    var ta = $('#tabAccounting');if(ta){ ta.classList.toggle('tab-active', !isP); }
  }

  var tp = $('#tabPatients');   if(tp){ tp.addEventListener('click', function(){ setTabSafe('patients'); }); }
  var ta = $('#tabAccounting'); if(ta){ ta.addEventListener('click', function(){ setTabSafe('accounting'); }); }

  // Diálogo Pacientes
  var btnAdd = $('#btnAdd');       if(btnAdd){ btnAdd.addEventListener('click', function(){ var d=$('#patientDialog'); if(d){ d.showModal? d.showModal(): d.setAttribute('open',''); } }); }
  var btnCancel = $('#btnCancel'); if(btnCancel){ btnCancel.addEventListener('click', function(){ var d=$('#patientDialog'); if(d){ d.close? d.close(): d.removeAttribute('open'); } }); }

  // Diálogo Contabilidad
  var btnTxAdd = $('#btnTxAdd');       if(btnTxAdd){ btnTxAdd.addEventListener('click', function(){ var d=$('#txDialog'); if(d){ d.showModal? d.showModal(): d.setAttribute('open',''); } }); }
  var btnTxCancel = $('#btnTxCancel'); if(btnTxCancel){ btnTxCancel.addEventListener('click', function(){ var d=$('#txDialog'); if(d){ d.close? d.close(): d.removeAttribute('open'); } }); }

  setTabSafe('patients');
  console.log('Hotfix2 listo');
});
</script>
</body>
</html>


