function doGet(e){
  const mode = e.parameter.mode || '';
  if (mode === 'transactions') {
    return json(getTransactions_());
  }
  // ... ya tienes: patients, histories, etc.
  return json([]);
}

function doPost(e){
  const body = JSON.parse(e.postData.contents);
  const { action, data } = body || {};
  if (action === 'upsert_tx')  return json(upsertTx_(data));
  if (action === 'delete_tx')  return json(deleteTx_(data && data.id));
  // ... ya tienes: upsert_patient, delete_patient, add_history, delete_history
  return json({ ok:false, error:'AcciÃ³n no soportada' });
}

function getTransactions_(){
  const sh = ss().getSheetByName('Transactions');
  if(!sh) return [];
  const values = sh.getDataRange().getValues();
  const head = values.shift();
  const idx = Object.fromEntries(head.map((h,i)=>[h,i]));
  return values.map(r => ({
    id: r[idx.id],
    fecha: r[idx.fecha],
    tipo: r[idx.tipo],
    categoria: r[idx.categoria],
    concepto: r[idx.concepto],
    monto: Number(r[idx.monto] || 0),
    metodo: r[idx.metodo],
    paciente: r[idx.paciente],
    notas: r[idx.notas],
    created_at: r[idx.created_at],
    updated_at: r[idx.updated_at],
  }));
}

function upsertTx_(t){
  const sh = ss().getSheetByName('Transactions') || ss().insertSheet('Transactions');
  const head = ['id','fecha','tipo','categoria','concepto','monto','metodo','paciente','notas','created_at','updated_at'];
  if(sh.getLastRow()===0){ sh.appendRow(head); }
  const idx = Object.fromEntries(head.map((h,i)=>[h,i+1]));
  const id = t.id || ('t_'+Date.now().toString(36));
  const data = [
    id,
    t.fecha || '',
    t.tipo || '',
    t.categoria || '',
    t.concepto || '',
    Number(t.monto || 0),
    t.metodo || '',
    t.paciente || '',
    t.notas || '',
    new Date(), new Date()
  ];
  // buscar si existe
  const ids = sh.getRange(2, idx.id, sh.getLastRow()-1, 1).getValues().flat();
  const row = ids.indexOf(id) + 2;
  if(row >= 2){
    sh.getRange(row, 1, 1, head.length).setValues([data]);
  }else{
    sh.appendRow(data);
  }
  return { ok:true, id };
}

function deleteTx_(id){
  if(!id) return { ok:false, error:'Sin id' };
  const sh = ss().getSheetByName('Transactions');
  if(!sh) return { ok:true };
  const values = sh.getDataRange().getValues();
  const head = values.shift();
  const idx = Object.fromEntries(head.map((h,i)=>[h,i]));
  const rowIdx = values.findIndex(r => r[idx.id] === id);
  if(rowIdx >= 0){
    sh.deleteRow(rowIdx + 2);
  }
  return { ok:true };
}

function ss(){ return SpreadsheetApp.getActive(); }
function json(o){
  return ContentService.createTextOutput(JSON.stringify(o))
    .setMimeType(ContentService.MimeType.JSON);
}
